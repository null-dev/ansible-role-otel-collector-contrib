---
- name: Set binary install directory for Arch
  ansible.builtin.set_fact:
    otel_collector_contrib_binary_install_dir: "/usr/bin"
    otel_collector_contrib_build_dir: "/tmp/otelcol-contrib_build"

- name: Install base-devel
  community.general.pacman:
    name: base-devel
    state: present
  become: true

- name: Create otel group
  ansible.builtin.group:
    name: "{{ otel_collector_contrib_group }}"
    system: true
    state: present
  become: true

- name: Create otel user
  ansible.builtin.user:
    name: "{{ otel_collector_contrib_user }}"
    group: "{{ otel_collector_contrib_group }}"
    system: true
    shell: /sbin/nologin
    create_home: false
    state: present
  become: true

- name: Check if otelcol-contrib is installed
  ansible.builtin.command: pacman -Q otelcol-contrib
  register: pacman_query
  ignore_errors: true
  changed_when: false
  become: false

- name: Determine if build is needed
  ansible.builtin.set_fact:
    build_needed: >-
      {{
        pacman_query.rc != 0 or
        otel_collector_contrib_version ~ '-1' not in pacman_query.stdout
      }}

- name: Create build directory
  ansible.builtin.file:
    path: "{{ otel_collector_contrib_build_dir }}"
    state: directory
    mode: '0755'
  become: false
  when: build_needed

- name: Copy PKGBUILD
  ansible.builtin.template:
    src: PKGBUILD.j2
    dest: "{{ otel_collector_contrib_build_dir }}/PKGBUILD"
    mode: '0644'
  become: false
  when: build_needed

- name: Copy systemd service file
  ansible.builtin.template:
    src: otelcol-contrib.service.j2
    dest: "{{ otel_collector_contrib_build_dir }}/{{ otel_collector_contrib_service_name }}.service"
    mode: '0644'
  become: false
  when: build_needed

- name: Build package with makepkg
  ansible.builtin.command:
    cmd: makepkg -s --noconfirm
    chdir: "{{ otel_collector_contrib_build_dir }}"
  become: false
  changed_when: true
  when: build_needed

- name: Find built package
  ansible.builtin.find:
    paths: "{{ otel_collector_contrib_build_dir }}"
    patterns: "otelcol-contrib-*.pkg.tar.zst"
  register: built_package
  become: false
  when: build_needed

- name: Assert two packages found (main and debug)
  ansible.builtin.assert:
    that: built_package.matched == 2
    fail_msg: "Expected 2 packages (main and debug), found {{ built_package.matched }}"
  when: build_needed

- name: Install built packages
  ansible.builtin.command:
    cmd: "pacman -U --noconfirm {{ built_package.files | map(attribute='path') | join(' ') }}"
  become: true
  changed_when: true
  when: build_needed
  notify: restart otelcol-contrib

- name: Cleanup build directory
  ansible.builtin.file:
    path: "{{ otel_collector_contrib_build_dir }}"
    state: absent
  become: true
  when: build_needed
